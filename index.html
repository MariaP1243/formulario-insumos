<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Formulario de Solicitud de Insumos</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    background: #f7f9fc;
    font-family: 'Roboto', sans-serif;
    color: #333;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }
  h1 {
    color: #2c3e50;
    margin-bottom: 10px;
  }
  h2 {
    color: #34495e;
    margin-top: 30px;
  }
  .container {
    max-width: 900px;
    width: 100%;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    padding: 20px 30px 40px 30px;
  }

  form {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 30px;
  }

  label {
    font-weight: 700;
    margin-bottom: 6px;
  }

  input[type="text"], select, input[type="number"] {
    font-size: 1em;
    padding: 10px 12px;
    border: 2px solid #bdc3c7;
    border-radius: 6px;
    transition: border-color 0.3s ease;
    width: 100%;
  }
  input[type="text"]:focus, select:focus, input[type="number"]:focus {
    border-color: #2980b9;
    outline:none;
  }

  .item-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    align-items: center;
    gap: 16px;
    margin-bottom: 8px;
  }
  .item-row > * {
    width: 100%;
  }
  .remove-btn {
    background: #e74c3c;
    border: none;
    color: white;
    border-radius: 4px;
    padding: 6px 14px;
    cursor: pointer;
    font-weight: 700;
    transition: background 0.3s ease;
  }
  .remove-btn:hover {
    background: #c0392b;
  }

  .add-item-btn {
    background: #27ae60;
    color: white;
    border: none;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    width: fit-content;
    margin-top: -4px;
    transition: background 0.3s ease;
  }
  .add-item-btn:hover {
    background: #1e8449;
  }

  button.submit-btn {
    background: #2980b9;
    border: none;
    color: white;
    font-weight: 700;
    padding: 14px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.1em;
    transition: background 0.3s ease;
    box-shadow: 0 6px 12px rgba(41,128,185,0.4);
  }
  button.submit-btn:hover {
    background: #1f618d;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 12px rgba(0,0,0,0.1);
  }
  thead {
    background: #2980b9;
    color: white;
  }
  th, td {
    padding: 12px 14px;
    text-align: center;
    border-bottom: 1px solid #ddd;
  }
  tbody tr:nth-child(even) {
    background: #f4f6f8;
  }
  select.status-select {
    padding: 6px 10px;
    border-radius: 6px;
    border: 1.5px solid #ccc;
    font-weight: 600;
    cursor: pointer;
    transition: border-color 0.3s ease;
  }
  select.status-select:focus {
    border-color: #2980b9;
    outline: none;
  }
  .status-solicitado {
    color: #2980b9;
    font-weight: 700;
  }
  .status-entregado {
    color: #27ae60;
    font-weight: 700;
  }
  .status-rechazado {
    color: #e74c3c;
    font-weight: 700;
  }
  .inventory-status {
    font-weight: 700;
  }
  .footer {
    margin-top: 40px;
    font-size: 0.9em;
    color: #7f8c8d;
  }
  @media (max-width: 640px) {
    .item-row {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .remove-btn {
      width: 100%;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>Formulario de Solicitud de Insumos</h1>
    <form id="request-form" autocomplete="off">
      <div>
        <label for="requester">Quién realiza la solicitud:</label>
        <input type="text" id="requester" name="requester" placeholder="Nombre del solicitante" required />
      </div>
      <div>
        <label>Seleccionar insumos y cantidad solicitada:</label>
        <div id="items-container"></div>
        <button type="button" class="add-item-btn" id="add-item-btn">+ Agregar insumo</button>
      </div>
      <button type="submit" class="submit-btn">Enviar solicitud</button>
    </form>

    <h2>Solicitudes</h2>
    <table id="requests-table" aria-label="Tabla de solicitudes">
      <thead>
        <tr>
          <th>Solicitante</th>
          <th>Insumo</th>
          <th>Cantidad</th>
          <th>Estado</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        <!-- Requests will be populated here -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="5" style="text-align:right; padding:10px;">
            <button id="export-btn" style="padding: 10px 20px; font-weight:700; background:#3498db; border:none; border-radius:8px; color:#fff; cursor:pointer; transition:background 0.3s ease;">Exportar a Excel (CSV)</button>
          </td>
        </tr>
      </tfoot>
    </table>

    <h2>Inventario de Insumos</h2>
    <table id="inventory-table" aria-label="Tabla de inventario">
      <thead>
        <tr>
          <th>Insumo</th>
          <th>Cantidad Disponible</th>
        </tr>
      </thead>
      <tbody>
        <!-- Inventory items populated here -->
      </tbody>
    </table>
    <div class="footer">© 2024 Sistema de Gestión de Insumos</div>
  </div>

<script>
(() => {
  // Initial inventory example data
  const initialInventory = [
    { id: 'insumo1', name: 'Papel A4', quantity: 150 },
    { id: 'insumo2', name: 'Tinta impresora negra', quantity: 40 },
    { id: 'insumo3', name: 'Bolígrafo azul', quantity: 200 },
    { id: 'insumo4', name: 'Carpeta colgante', quantity: 75 },
    { id: 'insumo5', name: 'Clips metálicos', quantity: 500 }
  ];

  // State vars
  let inventory = [];
  let requests = [];

  // Elements
  const requesterInput = document.getElementById('requester');
  const itemsContainer = document.getElementById('items-container');
  const addItemBtn = document.getElementById('add-item-btn');
  const requestForm = document.getElementById('request-form');
  const requestsTableBody = document.querySelector('#requests-table tbody');
  const inventoryTableBody = document.querySelector('#inventory-table tbody');
  const exportBtn = document.getElementById('export-btn');

  // Load saved data or init fresh
  function loadData() {
    const inv = localStorage.getItem('inventory');
    const reqs = localStorage.getItem('requests');
    if (inv) {
      try {
        inventory = JSON.parse(inv);
      } catch {
        inventory = JSON.parse(JSON.stringify(initialInventory));
      }
    } else {
      inventory = JSON.parse(JSON.stringify(initialInventory));
    }
    if (reqs) {
      try {
        requests = JSON.parse(reqs);
      } catch {
        requests = [];
      }
    } else {
      requests = [];
    }
  }

  // Save data
  function saveData() {
    localStorage.setItem('inventory', JSON.stringify(inventory));
    localStorage.setItem('requests', JSON.stringify(requests));
  }

  // Generate option elements for items
  function generateOptions(selectedId) {
    return inventory.map(item => {
      const selected = item.id === selectedId ? 'selected' : '';
      return `<option value="${item.id}" ${selected}>${item.name} (Disponible: ${item.quantity})</option>`;
    }).join('');
  }

  // Add an item row for selection and quantity input
  function addItemRow(selectedItem = null, qty = 1) {
    const row = document.createElement('div');
    row.classList.add('item-row');

    const select = document.createElement('select');
    select.required = true;
    select.innerHTML = generateOptions(selectedItem ? selectedItem.id : '');
    row.appendChild(select);

    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = '1';
    qtyInput.value = qty;
    qtyInput.required = true;
    qtyInput.style.maxWidth = '80px';
    row.appendChild(qtyInput);

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-btn';
    removeBtn.title = 'Eliminar este insumo';
    removeBtn.textContent = 'Quitar';
    removeBtn.addEventListener('click', () => {
      row.remove();
    });
    row.appendChild(removeBtn);

    itemsContainer.appendChild(row);
  }

  // Clear all items
  function clearItems() {
    itemsContainer.innerHTML = '';
  }

  // Render requests table
  function renderRequests() {
    requestsTableBody.innerHTML = '';
    if (requests.length === 0) {
      const tr = document.createElement('tr');
      const tdEmpty = document.createElement('td');
      tdEmpty.colSpan = 5;
      tdEmpty.textContent = 'No hay solicitudes aún.';
      tdEmpty.style.fontStyle = 'italic';
      tr.appendChild(tdEmpty);
      requestsTableBody.appendChild(tr);
      return;
    }

    requests.forEach((req, i) => {
      req.items.forEach((item, idx) => {
        const tr = document.createElement('tr');

        if (idx === 0) {
          // Requester cell with rowspan for multiple items
          const tdRequester = document.createElement('td');
          tdRequester.rowSpan = req.items.length;
          tdRequester.textContent = req.requester;
          tr.appendChild(tdRequester);
        }
        // Item name
        const tdItem = document.createElement('td');
        const invItem = inventory.find(invIt => invIt.id === item.id);
        tdItem.textContent = invItem ? invItem.name : item.id;
        tr.appendChild(tdItem);

        // Quantity
        const tdQty = document.createElement('td');
        tdQty.textContent = item.quantity;
        tr.appendChild(tdQty);

        // Status - select input
        const tdStatus = document.createElement('td');
        const statusSelect = document.createElement('select');
        statusSelect.className = 'status-select';
        ['Solicitado', 'Entregado', 'Rechazado'].forEach(status => {
          const option = document.createElement('option');
          option.value = status.toLowerCase();
          option.textContent = status;
          if (item.status === status.toLowerCase()) {
            option.selected = true;
          }
          statusSelect.appendChild(option);
        });
        tdStatus.appendChild(statusSelect);
        tr.appendChild(tdStatus);

        // Action column: empty or add extra controls if needed
        const tdAction = document.createElement('td');
        tdAction.style.minWidth = '100px';
        tr.appendChild(tdAction);

        requestsTableBody.appendChild(tr);

        // Listen for status change to update inventory accordingly
        statusSelect.addEventListener('change', () => {
          updateStatus(i, idx, statusSelect.value);
        });
      });
    });
  }

  // Render inventory table
  function renderInventory() {
    inventoryTableBody.innerHTML = '';
    inventory.forEach(item => {
      const tr = document.createElement('tr');
      const tdName = document.createElement('td');
      tdName.textContent = item.name;
      tr.appendChild(tdName);

      const tdQty = document.createElement('td');
      tdQty.textContent = item.quantity;
      if (item.quantity === 0) {
        tdQty.style.color = '#e74c3c';
        tdQty.style.fontWeight = '700';
      }
      tr.appendChild(tdQty);

      inventoryTableBody.appendChild(tr);
    });
  }

  // Update the status of a request item, adjust inventory if needed
  function updateStatus(requestIndex, itemIndex, newStatus) {
    const reqItem = requests[requestIndex].items[itemIndex];
    const prevStatus = reqItem.status;
    if (prevStatus === newStatus) return;

    const inventoryItem = inventory.find(invIt => invIt.id === reqItem.id);
    if (!inventoryItem) return;

    // Adjust inventory only if status change affects inventory
    // Rules:
    // From 'solicitado' to 'entregado' => subtract quantity from inventory (if enough)
    // From 'entregado' to 'solicitado' => add quantity back to inventory
    // From any to 'rechazado' => if previous was 'entregado', add quantity back; else no change
    // From 'rechazado' to 'entregado' => subtract quantity from inventory (if enough)
    // From 'solicitado' to 'rechazado' => no inventory change

    const qty = reqItem.quantity;
    let newInventoryQuantity = inventoryItem.quantity;

    if (prevStatus === 'solicitado' && newStatus === 'entregado') {
      if (inventoryItem.quantity >= qty) {
        newInventoryQuantity -= qty;
      } else {
        alert(`No hay suficiente inventario para entregar ${qty} de ${inventoryItem.name}.`);
        revertStatusSelect(requestIndex, itemIndex, prevStatus);
        return;
      }
    } else if (prevStatus === 'entregado' && newStatus === 'solicitado') {
      newInventoryQuantity += qty;
    } else if (prevStatus === 'entregado' && newStatus === 'rechazado') {
      newInventoryQuantity += qty;
    } else if (prevStatus === 'rechazado' && newStatus === 'entregado') {
      if (inventoryItem.quantity >= qty) {
        newInventoryQuantity -= qty;
      } else {
        alert(`No hay suficiente inventario para entregar ${qty} de ${inventoryItem.name}.`);
        revertStatusSelect(requestIndex, itemIndex, prevStatus);
        return;
      }
    }

    inventoryItem.quantity = newInventoryQuantity;
    reqItem.status = newStatus;
    saveData();
    renderInventory();
    renderRequests();
  }

  // Revert the status-select to previous value if validation fails
  function revertStatusSelect(requestIndex, itemIndex, prevStatus) {
    // rerender the requests, no direct revert needed because renderRequests resets the selects
    renderRequests();
  }

  // Validate and collect form data on submit
  function handleSubmit(e) {
    e.preventDefault();
    const requester = requesterInput.value.trim();
    if (!requester) {
      alert('Por favor ingrese el nombre de quien realiza la solicitud.');
      return;
    }
    // Collect items
    const rows = Array.from(itemsContainer.children);
    if (rows.length === 0) {
      alert('Debe agregar al menos un insumo para solicitar.');
      return;
    }

    const items = [];

    for (const row of rows) {
      const select = row.querySelector('select');
      const qtyInput = row.querySelector('input[type="number"]');
      if (!select || !qtyInput) continue;

      const itemId = select.value;
      const quantity = parseInt(qtyInput.value, 10);

      if (!itemId) {
        alert('Debe seleccionar un insumo en cada fila.');
        return;
      }
      if (!(quantity > 0)) {
        alert('La cantidad debe ser un número entero mayor a 0.');
        return;
      }

      items.push({ id: itemId, quantity, status: 'solicitado' });
    }

    if (items.length === 0) {
      alert('Debe agregar al menos un insumo para solicitar.');
      return;
    }

    // Add to requests with current date and unique id (timestamp)
    const newRequest = {
      id: Date.now(),
      requester,
      items
    };
    requests.push(newRequest);
    saveData();
    renderRequests();
    clearItems();
    addItemRow();
    requestForm.reset();
    alert('Solicitud guardada correctamente.');
  }

  // Export requests as CSV
  function exportToCSV() {
    if(requests.length === 0){
      alert('No hay solicitudes para exportar.');
      return;
    }
    let csv = 'Solicitante,Insumo,Cantidad,Estado\n';
    requests.forEach(req => {
      req.items.forEach(item => {
        const invItem = inventory.find(invIt => invIt.id === item.id);
        const itemName = invItem ? invItem.name : item.id;
        const estadoCap = item.status.charAt(0).toUpperCase() + item.status.slice(1);
        csv += `"${req.requester}","${itemName}",${item.quantity},"${estadoCap}"\n`;
      });
    });

    const blob = new Blob([csv], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'solicitudes_insumos.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // Initialization
  function init() {
    loadData();
    renderInventory();
    renderRequests();
    clearItems();
    addItemRow();

    // Event listeners
    addItemBtn.addEventListener('click', () => addItemRow());
    requestForm.addEventListener('submit', handleSubmit);
    exportBtn.addEventListener('click', exportToCSV);
  }

  init();
})();
</script>
</body>
</html>

